<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Entrata Webhooks Diagnostic Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.5/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f6f8; padding: 2rem; }
        h1 { color: #12334e; }
        #status-bar { margin-top: 1rem; padding: 0.5rem; border-radius: 6px; display: inline-block; font-weight: bold; }
        .ok { background: #c6f6d5; color: #22543d; }
        .warn { background: #fefcbf; color: #744210; }
        .error { background: #fed7d7; color: #742a2a; }
        #logs { margin-top: 2rem; padding: 1rem; background: #fff; border-radius: 8px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1); white-space: pre-wrap;
                font-family: monospace; height: 500px; overflow-y: auto; }
        .log-entry { margin: 0.25rem 0; }
        .info { color: #12334e; }
        .success { color: green; }
        .error-log { color: red; }
        .data { color: #555; }
    </style>
</head>
<body>
    <h1>üì° Entrata Webhooks Diagnostic Viewer</h1>
    <div>
        Function App: <span id="func-status" class="warn">‚è≥ Checking...</span> |
        SignalR: <span id="signalr-status" class="warn">‚è≥ Connecting...</span>
    </div>
    <div id="logs">‚è≥ Initializing...</div>

<script>
    const logsDiv = document.getElementById("logs");
    const funcStatus = document.getElementById("func-status");
    const signalrStatus = document.getElementById("signalr-status");

    function log(message, type="info", data=null) {
        const entry = document.createElement("div");
        entry.classList.add("log-entry", type === "error" ? "error-log" : type);
        let content = `üìù ${new Date().toLocaleTimeString()} - ${message}`;
        if (data) {
            content += "\n" + (typeof data === "string" ? data : JSON.stringify(data, null, 2));
        }
        entry.textContent = content;
        logsDiv.appendChild(entry);
        logsDiv.scrollTop = logsDiv.scrollHeight; // auto-scroll
        console[type === "error" ? "error" : "log"](message, data || "");
    }

    // ====== Function App Health Check ======
    async function checkFunctionApp() {
        try {
            const resp = await fetch("https://entratawebhookv2.azurewebsites.net/api/negotiate", { method: "POST" });
            const text = await resp.text();
            if (resp.ok && text.trim()) {
                funcStatus.textContent = "‚úÖ Healthy";
                funcStatus.className = "ok";
                log("Function App responded OK", "success", { status: resp.status, body: text });
                return JSON.parse(text);
            } else {
                funcStatus.textContent = "‚ö†Ô∏è Unhealthy";
                funcStatus.className = "warn";
                log("Function App unhealthy response", "error", { status: resp.status, body: text });
                return null;
            }
        } catch (err) {
            funcStatus.textContent = "‚ùå Error";
            funcStatus.className = "error";
            log("Function App check failed", "error", err);
            return null;
        }
    }

    // ====== SignalR Setup ======
    async function startSignalR() {
        const negotiateData = await checkFunctionApp();
        if (!negotiateData) return;

        try {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl(negotiateData.url, {
                    accessTokenFactory: () => negotiateData.accessToken
                })
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on("newWebhookEvent", (data) => {
                log("üì© Webhook event received", "success", data);
            });

            connection.onclose(err => {
                signalrStatus.textContent = "‚ùå Disconnected";
                signalrStatus.className = "error";
                log("SignalR connection closed", "error", err);
            });
            connection.onreconnecting(err => {
                signalrStatus.textContent = "‚ö†Ô∏è Reconnecting...";
                signalrStatus.className = "warn";
                log("SignalR reconnecting...", "error", err);
            });
            connection.onreconnected(id => {
                signalrStatus.textContent = "‚úÖ Reconnected";
                signalrStatus.className = "ok";
                log("SignalR reconnected", "success", { connectionId: id });
            });

            log("Starting SignalR connection...", "info");
            await connection.start();
            signalrStatus.textContent = "‚úÖ Connected";
            signalrStatus.className = "ok";
            log("Connected to SignalR", "success");

        } catch (err) {
            signalrStatus.textContent = "‚ùå Error";
            signalrStatus.className = "error";
            log("SignalR start failed", "error", err);
        }
    }

    // Start everything
    startSignalR();

    // Re-check Function App every 60s
    setInterval(checkFunctionApp, 60000);
</script>
</body>
</html>
